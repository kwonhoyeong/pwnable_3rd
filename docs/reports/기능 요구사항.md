# NPM Threat Intelligence Platform - 기능 요구사항 명세서

## 1. 패키지 분석 요청 기능 (Package Analysis Request)

사용자가 분석하고자 하는 대상(패키지 또는 CVE)을 시스템에 요청하고, 시스템이 이를 접수하여 처리하는 기능입니다.

### 1.1 분석 대상 입력
- **패키지 검색**: 사용자는 패키지 이름(예: `react`, `lodash`)과 생태계(예: `npm`, `pip`)를 입력하여 분석을 요청할 수 있어야 한다.
- **CVE 검색**: 사용자는 특정 CVE ID(예: `CVE-2021-32804`)를 입력하여 개별 취약점 분석을 요청할 수 있어야 한다.
- **버전 지정**: (선택 사항) 특정 패키지 버전을 지정하여 해당 버전에 대한 취약점만 분석 요청할 수 있어야 한다.

### 1.2 요청 처리 및 라우팅
- **캐시 확인**: 시스템은 요청된 분석 대상이 이미 분석되어 유효한 캐시(Redis)에 존재하는지 확인해야 한다.
- **DB 조회**: 캐시가 없을 경우, 데이터베이스(PostgreSQL)에 저장된 최신 분석 결과가 있는지 확인해야 한다.
- **신규 분석 트리거**: 데이터가 없거나 사용자가 `force=true` 옵션으로 강제 재분석을 요청한 경우, 새로운 분석 작업을 생성하여 작업 큐(Redis Queue)에 등록해야 한다.
- **상태 응답**: 분석이 진행 중인 경우, 사용자에게 `202 Accepted` 또는 `Analysis In Progress` 상태를 반환하고, 폴링(Polling)을 통해 결과를 대기하도록 안내해야 한다.

---

## 2. 취약점 수집 기능 (Vulnerability Collection)

분석 대상 패키지와 관련된 모든 보안 취약점 정보를 외부 소스에서 수집하는 기능입니다.

### 2.1 패키지-CVE 매핑
- **OSV 연동**: OSV(Open Source Vulnerabilities) 데이터베이스를 조회하여 패키지 이름과 관련된 모든 CVE ID 목록을 수집해야 한다.
- **버전 매칭**: 수집된 CVE가 영향을 미치는 구체적인 버전 범위(Version Range)를 식별하고, 사용자가 요청한 버전이 이에 해당되는지 필터링해야 한다.
- **데이터 정규화**: 다양한 소스에서 수집된 취약점 식별자를 표준 CVE 포맷으로 정규화해야 한다.

---

## 3. 위험 점수 수집 기능 (Risk Score Collection)

식별된 각 취약점에 대해 객관적인 정량적 위험 지표를 수집하는 기능입니다.

### 3.1 CVSS 점수 수집
- **NVD 연동**: NVD(National Vulnerability Database) API를 통해 각 CVE의 CVSS(Common Vulnerability Scoring System) 점수(Base Score, Vector String)를 수집해야 한다.
- **Rate Limit 처리**: NVD API의 호출 제한을 준수하며, 실패 시 재시도(Retry) 또는 대체 소스(Perplexity 등)를 통해 점수를 확보해야 한다.

### 3.2 EPSS 점수 수집
- **FIRST 연동**: FIRST.org API를 통해 각 CVE의 EPSS(Exploit Prediction Scoring System) 점수(실제 악용 확률)를 수집해야 한다.
- **최신성 유지**: EPSS 점수는 매일 업데이트되므로, 분석 시점의 최신 점수를 반영해야 한다.

---

## 4. 공격 사례 분석 기능 (Attack Case Analysis)

단순한 점수를 넘어, 실제 야생(In-the-wild)에서 발생한 공격 사례와 위협 정보를 수집하는 기능입니다.

### 4.1 위협 인텔리전스 검색
- **Perplexity AI 연동**: Perplexity API를 활용하여 보안 블로그, 기술 문서, 해킹 포럼 등 웹 상의 최신 위협 정보를 검색해야 한다.
- **공격 사례 추출**: 검색 결과에서 실제 공격 시나리오, PoC(Proof of Concept) 코드 존재 여부, 피해 사례 등을 텍스트 형태로 추출해야 한다.

---

## 5. AI 통합 분석 기능 (AI Integrated Analysis)

수집된 모든 정량적/정성적 데이터를 종합하여 AI가 최종 위험도를 판단하는 핵심 기능입니다.

### 5.1 앙상블(Ensemble) 분석
- **다중 모델 활용**: Claude(주 분석가)와 GPT-5(검증가) 두 개의 LLM을 동시에 활용하여 교차 검증을 수행해야 한다.
- **위험도 평가**: CVSS/EPSS 점수와 공격 사례를 종합하여 최종 위험 등급(CRITICAL, HIGH, MEDIUM, LOW)을 산정해야 한다.
- **불일치 해결**: 두 모델의 분석 결과가 상이할 경우, 합의 신뢰도(Consensus Confidence) 점수를 계산하여 더 신뢰할 수 있는 결과를 채택해야 한다.

### 5.2 검증 및 환각 방지
- **Fact Checking**: AI가 생성한 분석 결과가 NVD의 공식 데이터(CVSS 점수 등)와 일치하는지 자동으로 검증해야 한다.
- **Hallucination Risk 평가**: 분석 보고서 내에 근거 없는 내용이 포함될 확률(Hallucination Risk Score)을 0.0~1.0 사이의 점수로 산출해야 한다.
- **대응 방안 생성**: 취약점별로 구체적인 해결 방안(패치 버전, 설정 변경, 완화 조치 등)을 Markdown 형식으로 생성해야 한다.

---

## 6. 결과 저장 기능 (Result Storage)

분석 완료된 데이터를 구조화하여 안전하게 저장하고 관리하는 기능입니다.

### 6.1 데이터 영속화
- **RDBMS 저장**: 분석 결과(위험 등급, 점수, 요약, 권장사항)를 PostgreSQL 데이터베이스에 관계형 데이터로 저장해야 한다.
- **이력 관리**: 동일 패키지에 대한 과거 분석 이력을 보존하여 시계열 변화를 추적할 수 있어야 한다.

### 6.2 캐싱 및 최적화
- **Redis 캐싱**: 빈번하게 조회되는 분석 결과는 Redis에 캐싱하여(TTL 설정) 응답 속도를 최적화해야 한다.
- **데이터 격리**: 생태계(npm, pip, apt)별로 데이터를 논리적으로 분리하여 저장해야 한다.

---

## 7. 출력 기능 (Output)

최종 사용자가 분석 결과를 직관적으로 확인하고 활용할 수 있도록 제공하는 기능입니다.

### 7.1 API 응답
- **JSON 포맷**: 외부 시스템 연동을 위해 표준화된 JSON 포맷으로 분석 결과를 제공해야 한다.
- **상세 정보 포함**: CVE ID, 위험도, 점수, 요약, 대응 방안 등 모든 상세 정보를 포함해야 한다.

### 7.2 시각화 대시보드 (Frontend)
- **위험도 분포 차트**: 전체 취약점의 위험도 분포(Critical/High/Medium/Low)를 바 차트 등으로 시각화해야 한다.
- **리스트 뷰**: 위험 점수 순으로 정렬된 취약점 목록을 제공해야 한다.
- **상세 보고서 뷰**: Markdown으로 작성된 AI 분석 보고서를 가독성 좋게 렌더링하여 보여주어야 한다.
- **실시간 상태 표시**: 분석 진행률, 로딩 상태, 에러 메시지 등을 사용자에게 실시간으로 피드백해야 한다.
