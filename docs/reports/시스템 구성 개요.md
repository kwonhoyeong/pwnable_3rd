# NPM Threat Intelligence Platform - 시스템 구성 개요

## 시스템 아키텍처 개요

본 시스템은 NPM 패키지의 보안 취약점을 자동으로 수집, 분석, 평가하는 AI 기반 위협 인텔리전스 플랫폼입니다. 마이크로서비스 아키텍처를 기반으로 5개의 계층으로 구성되어 있으며, 각 계층은 독립적으로 동작하면서 상호 연계됩니다.

---

## 1. 입력 계층 (Input Layer)

사용자 요청을 받아들이고 시스템과의 인터페이스를 제공하는 계층입니다.

### 1.1 Web Frontend
- **기술 스택**: React + TypeScript + Vite
- **포트**: 5173
- **주요 기능**:
  - 패키지/CVE 검색 인터페이스 제공
  - 실시간 위험도 통계 대시보드
  - 분석 히스토리 조회 및 관리
  - Dark Sentinel 테마 적용된 사용자 UI/UX

### 1.2 Query API
- **기술 스택**: FastAPI (Python)
- **포트**: 8004
- **주요 기능**:
  - RESTful API 엔드포인트 제공
  - 사용자 쿼리 검증 및 라우팅
  - API Key 인증 및 보안
  - 캐싱 레이어 관리 (Redis)
- **주요 엔드포인트**:
  - `GET /api/v1/query` - 패키지/CVE 조회
  - `GET /api/v1/history` - 분석 히스토리
  - `GET /api/v1/stats` - 위험도 통계
  - `GET /health` - 헬스체크

---

## 2. 수집 계층 (Collection Layer)

외부 데이터 소스로부터 취약점 정보를 수집하는 계층입니다.

### 2.1 Mapping Collector
- **기술 스택**: FastAPI (Python)
- **포트**: 8000
- **데이터 소스**: OSV (Open Source Vulnerabilities)
- **주요 기능**:
  - NPM 패키지와 CVE ID 매핑 정보 수집
  - 패키지별 버전 범위와 CVE 연관 관계 저장
  - 정기적 데이터 동기화 및 업데이트

### 2.2 EPSS Fetcher
- **기술 스택**: FastAPI (Python)
- **포트**: 8001
- **데이터 소스**: FIRST EPSS (Exploit Prediction Scoring System)
- **주요 기능**:
  - CVE별 실제 악용 가능성 점수(EPSS) 수집
  - 확률 기반 위험도 평가 데이터 제공
  - 일일 EPSS 스코어 업데이트

### 2.3 CVSS Fetcher
- **기술 스택**: FastAPI (Python)
- **포트**: 8006
- **데이터 소스**: NVD (National Vulnerability Database)
- **주요 기능**:
  - CVE별 CVSS 점수 수집
  - Base Score, Temporal Score, Vector String 저장
  - NVD API Rate Limiting 처리

---

## 3. AI 분석 계층 (AI Analysis Layer)

수집된 데이터를 AI 모델을 활용하여 심층 분석하는 계층입니다.

### 3.1 Agent Orchestrator (Worker)
- **기술 스택**: Python (Async Worker)
- **주요 기능**:
  - Redis 큐에서 분석 작업 소비
  - 분석 파이프라인 오케스트레이션
  - 마이크로서비스 간 통신 조율
- **처리 플로우**:
  1. 패키지-CVE 매핑 수집 (Mapping Collector)
  2. CVSS/EPSS 점수 수집 (CVSS/EPSS Fetcher)
  3. 위험도 우선순위화 (Top 10 선정)
  4. Threat Intelligence 수집 (Threat Agent)
  5. AI 위험도 분석 (Analyzer)
  6. 결과 검증 및 저장

### 3.2 Threat Agent
- **기술 스택**: FastAPI (Python) + Perplexity AI
- **포트**: 8002
- **주요 기능**:
  - 실제 공격 사례(Threat Cases) 수집
  - 온라인 보안 커뮤니티 정보 집계
  - 취약점별 실제 악용 사례 분석
  - Perplexity AI 기반 최신 위협 정보 검색

### 3.3 Analyzer
- **기술 스택**: FastAPI (Python) + Claude AI + GPT-5
- **포트**: 8003
- **주요 기능**:
  - **Ensemble AI 분석**: Claude와 GPT-5 교차 검증
  - 취약점 위험도 자동 평가 (CRITICAL/HIGH/MEDIUM/LOW)
  - 엔터프라이즈급 분석 리포트 생성 (Markdown)
  - 구체적 대응 권장사항 제공
- **검증 메커니즘**:
  - NVD 교차 검증 (Fact Checking)
  - Hallucination Risk 평가 (0.0~1.0)
  - Report Validation (버전 매칭, 일관성 체크)
  - Consensus Confidence 점수 (0.0~1.0)

---

## 4. 저장 계층 (Storage Layer)

분석 결과 및 메타데이터를 영구 보존하는 계층입니다.

### 4.1 PostgreSQL
- **버전**: 15-alpine
- **포트**: 15432
- **주요 테이블**:
  - `package_cve_mapping`: 패키지-CVE 매핑 정보
  - `epss_scores`: EPSS 점수 데이터
  - `cvss_scores`: CVSS 점수 데이터
  - `analysis_results`: AI 분석 결과물
- **데이터 격리**: Ecosystem별 데이터 분리 (npm/pip/apt)
- **인덱싱**: cve_id, package, ecosystem 복합 인덱스

### 4.2 Redis
- **버전**: alpine
- **포트**: 6379
- **주요 용도**:
  - **작업 큐**: 분석 작업 비동기 처리
  - **캐싱**: API 응답 캐싱 (TTL: 300초)
  - **세션 관리**: 임시 데이터 저장
- **키 패턴**:
  - `queue:analysis_jobs` - 분석 작업 큐
  - `query:npm:package:{name}` - 캐시 키

---

## 5. 출력 계층 (Output Layer)

분석 결과를 사용자에게 제공하는 계층입니다.

### 5.1 Query API (Response)
- **응답 형식**: JSON (RESTful)
- **주요 데이터 구조**:
  - `CVEDetail`: CVE별 상세 분석 결과
  - `QueryResponse`: 패키지/CVE 조회 응답
  - `StatsResponse`: 위험도 분포 통계
  - `HistoryResponse`: 분석 히스토리
- **에러 처리**:
  - `RESOURCE_NOT_FOUND`: 데이터 없음 → 자동 분석 트리거
  - `ANALYSIS_IN_PROGRESS`: 분석 진행 중 (폴링 대기)
  - `EXTERNAL_SERVICE_ERROR`: 외부 서비스 오류

### 5.2 Web Frontend (Dashboard)
- **주요 컴포넌트**:
  - **검색 인터페이스**: 패키지명/CVE ID 실시간 검색
  - **위험도 대시보드**: Risk Distribution Chart (CRITICAL/HIGH/MEDIUM/LOW/UNKNOWN)
  - **CVE 리스트**: 위험도 점수 기반 정렬
  - **상세 리포트**: Markdown 렌더링된 AI 분석 결과
- **실시간 업데이트**: 
  - 2분마다 `/stats` 엔드포인트 폴링
  - 분석 진행 중 상태 표시
  - 로딩 인디케이터 및 에러 핸들링

---

## 데이터 플로우

```
[사용자] 
  ↓ 검색 요청 (패키지명/CVE ID)
[Web Frontend / Query API] ← 입력 계층
  ↓ 캐시 확인 (Redis)
  ↓ DB 조회 (PostgreSQL)
  ↓ (없으면) 분석 작업 큐잉
[Redis Queue] 
  ↓
[Agent Orchestrator] ← AI 분석 계층
  ↓ 1. 매핑 수집
[Mapping Collector] ← 수집 계층
  ↓ 2. CVSS/EPSS 수집
[CVSS/EPSS Fetcher] ← 수집 계층
  ↓ 3. Threat Intel 수집
[Threat Agent] ← AI 분석 계층
  ↓ 4. AI 분석 & 검증
[Analyzer] ← AI 분석 계층
  ↓ 5. 결과 저장
[PostgreSQL] ← 저장 계층
  ↓ 6. 결과 반환
[Query API → Web Frontend] ← 출력 계층
  ↓
[사용자]
```

---

## 주요 특징

### 자동화된 분석 파이프라인
- 사용자 요청 시 자동으로 분석 작업 트리거
- 최대 120초 폴링으로 결과 대기
- 백그라운드에서 비동기 처리

### AI 기반 위험도 평가
- Claude AI와 GPT-5의 Ensemble 분석
- NVD 데이터 교차 검증
- Hallucination Risk 자동 평가
- 신뢰도 기반 응답 선택 (Consensus Confidence)

### 확장 가능한 아키텍처
- 마이크로서비스 기반 독립 배포
- Docker Compose 오케스트레이션
- 수평 확장 가능한 구조
- Ecosystem별 데이터 격리 (npm/pip/apt)

### 신뢰성 있는 데이터
- 다중 외부 소스 (OSV, NVD, FIRST)
- AI fallback 메커니즘 (NVD 실패 시 Perplexity)
- 데이터 일관성 검증
- Rate Limiting 자동 처리
